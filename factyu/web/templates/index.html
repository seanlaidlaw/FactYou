<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fact You - Semantic Search Lookup</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&family=Shadows+Into+Light&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap");

      .roboto-font-300 {
        font-family: "Roboto", "Helvetica Neue", "Arial", sans-serif;
        font-optical-sizing: auto;
        font-weight: 300;
        font-style: normal;
        font-variation-settings: "wdth" 100;
      }

      body {
        font-family: "Roboto", "Helvetica Neue", "Arial", sans-serif;
        background-color: #e6e6e6;
        margin: 0;
        padding: 0;
      }

      .container {
        max-width: 800px;
        margin: 80px auto;
        padding: 30px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0px 2px 30px rgba(0, 0, 0, 0.05);
      }

      textarea {
        width: 100%;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 16px;
        resize: none;
        outline: none;
      }

      .results {
        margin-top: 30px;
      }

      .result {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
      }

      .result:last-child {
        border-bottom: none;
      }

      .result-text {
        font-size: 12.5pt;
        line-height: 1.3;
        margin-bottom: 0.7em;
      }

      .result-context {
        margin-top: 4px;
        font-size: 12px;
        font-weight: 300;
        color: #666666;
        line-height: 1.4;
        margin-bottom: 3px;
        border-left: 2px solid #ccc;
        padding-left: 5px;
      }

      .result-context .highlight {
        font-weight: 400;
        color: #333;
      }

      .result-doi {
        color: #007bff;
        font-size: 13px;
      }

      .result-doi:hover {
        text-decoration: underline;
      }

      .result-other {
        font-family: sans-serif;
        font-size: small;
        font-style: oblique;
        color: dimgrey;
      }

      .result-other-div {
        display: none;
      }

      .show-citation {
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
        font-size: 13px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <textarea
        name="sentence"
        placeholder="Start typing your sentence..."
        oninput="executeSearch(this.value)"
      ></textarea>
      <div class="results"></div>
    </div>

    <script>
      function executeSearch(sentence) {
        if (!sentence) return; // Don't execute an empty search

        fetch("/search", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: "sentence=" + encodeURIComponent(sentence),
        })
          .then((response) => response.json())
          .then((data) => {
            let resultsDiv = document.querySelector(".results");
            resultsDiv.innerHTML = "";

            data.matching_entries.forEach((entry) => {
              let resultDiv = document.createElement("div");
              resultDiv.className = "result";

              let resultText = document.createElement("div");
              resultText.className = "result-text";
              resultText.textContent = entry.TextWtContext;
              resultDiv.appendChild(resultText);

              // Add the TextInSentence with Text highlighted in bold
              if (entry.TextInSentence && entry.Text) {
                let contextDiv = document.createElement("div");
                contextDiv.className = "result-context roboto-font-300";

                // Create highlighted text by replacing the Text within TextInSentence with bold version
                const context = entry.TextInSentence;
                const textToHighlight = entry.Text;

                // Safely escape the text for regex
                const escapeRegExp = (string) => {
                  return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                };

                // Replace with highlighted version (if found in context)
                const safeText = escapeRegExp(textToHighlight);
                const regex = new RegExp(`(${safeText})`, "gi");

                if (context.includes(textToHighlight)) {
                  const parts = context.split(regex);

                  parts.forEach((part) => {
                    if (part.toLowerCase() === textToHighlight.toLowerCase()) {
                      let span = document.createElement("span");
                      span.className = "highlight";
                      span.textContent = part;
                      contextDiv.appendChild(span);
                    } else if (part) {
                      contextDiv.appendChild(document.createTextNode(part));
                    }
                  });
                } else {
                  // Fallback if the exact text is not found
                  contextDiv.textContent = context;
                }

                resultDiv.appendChild(contextDiv);
              }

              if (entry.RefDOIs) {
                entry.RefDOIs.forEach((refdoi) => {
                  if (refdoi) {
                    let resultDOI = document.createElement("a");
                    resultDOI.className = "result-doi";
                    resultDOI.href = "https://dx.doi.org/" + refdoi;
                    resultDOI.textContent = "DOI: " + refdoi;
                    resultDiv.appendChild(resultDOI);
                    resultDiv.appendChild(document.createElement("br")); // Break line after each DOI
                  }
                });
              }

              let citationContainer;
              if (entry.RefOther && entry.RefOther.length > 0) {
                // Create "Show Citation" button
                let showCitationButton = document.createElement("span");
                showCitationButton.className = "show-citation";
                showCitationButton.textContent = `Show Citation (${entry.RefOther.length})`;
                showCitationButton.addEventListener("click", function () {
                  citationContainer.className =
                    citationContainer.className === "result-other-div"
                      ? ""
                      : "result-other-div";
                });
                resultDiv.appendChild(showCitationButton);

                citationContainer = document.createElement("div");
                citationContainer.className = "result-other-div";

                entry.RefOther.forEach((refother) => {
                  if (refother) {
                    let resultOther = document.createElement("span");
                    resultOther.className = "result-other";
                    resultOther.textContent = refother;
                    citationContainer.appendChild(resultOther);
                    citationContainer.appendChild(document.createElement("br")); // Break line after each refother
                  }
                });

                resultDiv.appendChild(citationContainer);
              }

              resultsDiv.appendChild(resultDiv);
            });
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>
  </body>
</html>
